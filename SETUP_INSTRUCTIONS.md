# Инструкция по настройке системы PhotoAlbums

## Создание первого администратора

База данных успешно настроена! Теперь необходимо создать первого администратора через Supabase Edge Function.

### Шаг 1: Создайте администратора через Edge Function

Используйте следующий API запрос для создания администратора:

```bash
curl -X POST https://your-project.supabase.co/functions/v1/create-admin \
  -H "Content-Type: application/json" \
  -H "apikey: YOUR_SUPABASE_ANON_KEY" \
  -d '{
    "email": "admin@photoalbums.com",
    "password": "SecurePassword123!",
    "name": "Администратор"
  }'
```

### Шаг 2: Войдите в систему

1. Откройте приложение
2. Используйте созданные учетные данные:
   - **Email:** admin@photoalbums.com
   - **Пароль:** SecurePassword123! (или ваш пароль)

### Шаг 3: Создание сотрудников

После входа как администратор:

1. Перейдите в раздел "Сотрудники"
2. Нажмите "Добавить сотрудника"
3. Заполните форму:
   - Полное имя
   - Email (будет использоваться для входа)
   - Пароль
   - Роль (Фотограф, Дизайнер, Администратор)
   - Дополнительные данные

## Альтернативный способ: Создание через Supabase Dashboard

Если Edge Function недоступна:

1. Откройте Supabase Dashboard
2. Перейдите в **Authentication** → **Users**
3. Нажмите **Add user** → **Create new user**
4. Заполните:
   - Email: admin@photoalbums.com
   - Password: SecurePassword123!
   - User Metadata:
     ```json
     {
       "name": "Администратор",
       "role": "admin"
     }
     ```
5. Подтвердите email автоматически
6. После создания профиль будет создан автоматически через триггер

## Структура базы данных

База данных содержит следующие таблицы:

- **profiles** - Профили сотрудников
- **projects** - Проекты и альбомы
- **project_members** - Участники проектов
- **project_files** - Файлы проектов
- **calendar_events** - События и расписание
- **comments** - Комментарии к проектам
- **reports** - Отчеты сотрудников (с Supabase Storage)
- **salary_calculations** - Расчеты зарплат
- **chats**, **chat_participants**, **messages** - Мессенджер

## Настройка Storage для отчетов

Для загрузки отчетов необходимо создать Storage bucket:

1. Откройте Supabase Dashboard
2. Перейдите в **Storage**
3. Создайте новый bucket с именем **reports**
4. Настройте политики доступа:
   - **SELECT**: Авторизованные пользователи могут читать свои файлы и админы все
   - **INSERT**: Авторизованные пользователи могут загружать
   - **DELETE**: Авторизованные пользователи могут удалять свои файлы

## Безопасность

Все таблицы защищены Row Level Security (RLS):

- **Администраторы** имеют полный доступ ко всем данным
- **Фотографы и Дизайнеры** видят:
  - Свои проекты
  - Профили всех сотрудников
  - Календарь событий
  - Свои отчеты
- **Отчеты**:
  - Администраторы видят все отчеты
  - Сотрудники видят только свои отчеты

## Решение проблем

### "Неверный пароль" при входе

**Причина:** Пользователь создан, но пароль установлен неправильно.

**Решение:**
1. Используйте Edge Function `create-user` для создания пользователей (она правильно устанавливает пароль)
2. Или используйте функцию `update-user-password` для сброса пароля

### Профиль не создается автоматически

**Причина:** Триггер не сработал.

**Решение:**
Вручную создайте профиль в SQL Editor:
```sql
INSERT INTO profiles (id, email, name, role)
SELECT id, email, 'Имя пользователя', 'admin'
FROM auth.users
WHERE email = 'admin@photoalbums.com'
ON CONFLICT (id) DO NOTHING;
```

### Не работает загрузка отчетов

**Причина:** Storage bucket не создан.

**Решение:**
1. Создайте bucket "reports" в Supabase Dashboard
2. Настройте политики доступа для авторизованных пользователей
